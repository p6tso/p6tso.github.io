# upload_file

## 1. Валидация входящих данных

| Операция | Источник данных | Тип данных | Обязательность | Проверка |
|----------|-----------------|------------|----------------|----------|
| Получение файла | multipart/form-data | Binary | Обязательно | Наличие файла в запросе |
| Получение subject | form-data поле | String | Обязательно | Не пустая строка, длина ≤ 256 символов |
| Получение original_name | Имя файла из формы | String | Обязательно | Не пустая строка, длина ≤ 512 символов |
| Проверка размера | Заголовок Content-Length | Integer | Обязательно | ≤ 100 МБ (104,857,600 байт) |
| Проверка MIME-типа | Content-Type файла | String | Обязательно | В списке разрешенных (pdf, docx, txt, md) |
| Генерация file_id | Алгоритм UUID v4 | UUID | Обязательно | Уникальность гарантируется алгоритмом |

## 2. Подготовка данных

**Последовательные операции:**
1. Определение пути хранения: `{year}/{month}/{file_id}.{extension}`
2. Создание временного файла на диске для буферизации
3. Расчет контрольной суммы (SHA-256) файла
4. Определение MIME-типа по содержимому (magic bytes)
5. Извлечение реального расширения из имени файла

## 3. Сохранение в объектное хранилище (MinIO)

| Операция | Куда сохранить | Что сохранить | Метаданные объекта | Обязательность |
|----------|----------------|---------------|---------------------|----------------|
| Загрузка файла | Bucket: `uniarchive-files`<br>Путь: из п.2 | Содержимое файла | - | Обязательно |
| Установка метаданных | Тот же объект | Метаданные: | `original-filename`: original_name<br>`content-type`: MIME-тип<br>`x-amz-meta-subject`: subject<br>`x-amz-meta-uploader`: uploaded_by | Обязательно |
| Получение URL | В переменную | storage_path | - | Обязательно |


## 4. Сохранение в базу данных (PostgreSQL)

### Таблица `files`:
| Поле | Источник данных | Тип данных | Обязательность | Примечание |
|------|-----------------|------------|----------------|------------|
| `id` | Сгенерированный file_id | UUID | PK, Обязательно | Первичный ключ |
| `original_name` | Из валидации | VARCHAR(512) | Обязательно | Оригинальное имя |
| `storage_path` | Из MinIO операции | VARCHAR(1024) | Обязательно | Путь в хранилище |
| `subject` | Из валидации | VARCHAR(256) | Обязательно | Учебный предмет |
| `file_size` | Из расчета | BIGINT | Обязательно | Размер в байтах |
| `mime_type` | Из определения | VARCHAR(128) | Обязательно | MIME-тип |
| `uploaded_at` | Текущее время | TIMESTAMPTZ | Обязательно | NOW() |
| `uploaded_by` | Контекст запроса | VARCHAR(128) | Опционально | Может быть NULL |

### Таблица `file_texts`:
| Поле | Источник данных | Тип данных | Обязательность | Примечание |
|------|-----------------|------------|----------------|------------|
| `file_id` | Тот же file_id | UUID | PK, FK, Обязательно | Ссылка на files.id |
| `extracted_text` | NULL | TEXT | Опционально | Заполнится позже |
| `processed_at` | NULL | TIMESTAMPTZ | Опционально | Заполнится позже |
| `processing_status` | Константа | VARCHAR(32) | Обязательно | Значение: 'pending' |
| `error_message` | NULL | TEXT | Опционально | NULL по умолчанию |

## 5. Подготовка события Kafka

**Последовательные операции:**
1. Формирование JSON структуры события
2. Генерация уникального `event_id` (UUID v4)
3. Установка `event_type`: `"FileUploaded"`
4. Добавление текущего времени в `timestamp`
5. Сбор всех данных из предыдущих шагов в поле `data`

**Структура события:**
```json
{
  "event_id": "uuid",
  "event_type": "FileUploaded",
  "timestamp": "ISO 8601",
  "producer": "file-upload-service",
  "data": {
    "file_id": "из операции 1",
    "storage_path": "из операции 3", 
    "original_name": "из валидации",
    "mime_type": "из определения",
    "file_size": "из расчета",
    "subject": "из валидации",
    "uploaded_by": "из контекста"
  }
}
```

## 6. Отправка в Kafka

**Последовательные операции:**
1. Выбор топика: `file.events.uploaded`
2. Установка ключа партиционирования = `file_id` (гарантирует порядок обработки файла)
3. Настройка гарантий доставки: `acks=all`
4. Отправка сообщения с таймаутом 5 секунд
5. При ошибке: 3 попытки ретрая с экспоненциальной задержкой

## 7. Формирование ответа клиенту

**Последовательные операции:**
1. Установка HTTP статуса: `201 Created`
2. Формирование заголовков:
    - `Location: /api/v1/files/{file_id}`
    - `X-File-ID: {file_id}`
3. Подготовка тела ответа в JSON
4. Расчет `estimated_processing_time` на основе размера файла

**Тело ответа:**
```json
{
  "file_id": "uuid",
  "status": "uploaded",
  "uploaded_at": "ISO 8601",
  "processing_status": "pending",
  "estimated_processing_time": 5,
  "download_url": "/api/v1/files/{file_id}/download",
  "details_url": "/api/v1/files/{file_id}"
}
```

## 8. Очистка и логирование

**Последовательные операции:**
1. Удаление временного файла с диска (если создавался)
2. Закрытие всех открытых потоков и дескрипторов
3. Логирование результата операции с ключевыми метриками:
    - Время выполнения
    - Размер файла
    - Статусы каждой операции
4. Увеличение счетчиков метрик (prometheus/grafana)

## Ошибки

| Код ошибки | Условие | HTTP статус | Действие |
|------------|---------|-------------|----------|
| `FILE_MISSING` | Файл не передан | 400 | "File is required" |
| `SUBJECT_MISSING` | subject не указан | 400 | "Subject is required" |
| `FILE_TOO_LARGE` | Размер > 100 МБ | 413 | "File size exceeds limit of 100MB" |
| `UNSUPPORTED_TYPE` | Неподдерживаемый MIME-тип | 400 | "Unsupported file type. Allowed: PDF, DOCX, TXT, MD" |
| `DB_CONNECTION_ERROR` | PostgreSQL недоступен | 503 | Откат MinIO операции |
| `DUPLICATE_FILE_ID` | Нарушение уникальности PK | 500 | Перегенерация file_id, ретрай |
| `FOREIGN_KEY_VIOLATION` | Нарушение FK file_texts→files | 500 | Откат всей транзакции |
| `MINIO_UNAVAILABLE` | MinIO недоступен | 503 | Откат операции |
| `STORAGE_FULL` | Недостаточно места | 507 | Откат операции |
| `UPLOAD_TIMEOUT` | Таймаут загрузки | 504 | Откат операции |
| `KAFKA_UNAVAILABLE` | Kafka недоступен | 503 | Файл загружен, но обработка отложена |
| `PRODUCE_ERROR` | Ошибка отправки | 500 | Логирование, ретрай |
| `TOPIC_NOT_EXIST` | Топик не существует | 500 | Создание топика, ретрай |


