# update_processing_status

## 1. Валидация входных параметров

| Параметр | Тип данных | Обязательность | Проверка |
|----------|------------|----------------|----------|
| `file_id` | UUID string | Обязательно | Формат UUID v4 |
| `status` | String | Обязательно | 'processing', 'completed', 'failed' |
| `extracted_text` | String | Условно | Требуется при status='completed' |
| `error_message` | String | Условно | Требуется при status='failed' |
| `processing_time_ms` | Integer | Опционально | > 0 |
| `text_metadata` | JSON | Опционально | Дополнительные метрики извлечения |

## 2. Проверка текущего состояния

**Последовательные операции:**
1. Запрос к таблице `files` для проверки существования файла
2. Запрос к таблице `file_texts` для получения текущего статуса
3. Проверка бизнес-правил:
    - Если файл не существует → ошибка
    - Если текущий статус 'completed' → запрет изменения на 'processing' (downgrade)
    - Если статус 'failed' → разрешена повторная обработка
    - Если статус не меняется → предупреждение в лог

## 3. Подготовка транзакции обновления

**Формирование полей для обновления:**
- Общие для всех статусов:
    - `processing_status` = новый статус
    - `processed_at` = текущее время
- Для статуса 'completed':
    - `extracted_text` = переданный текст
    - `text_length` = длина текста в символах
    - `error_message` = NULL
    - `text_metadata` = дополнительные метаданки (если предоставлены)
- Для статуса 'failed':
    - `error_message` = обрезанное сообщение об ошибке (макс 500 символов)
    - `extracted_text` = NULL
    - `text_length` = 0
- Для статуса 'processing':
    - `error_message` = NULL (если был ранее)

## 4. Выполнение обновления в PostgreSQL

**Последовательные операции:**
1. Начало транзакции
2. Обновление записи в таблице `file_texts`
3. Если записи в `file_texts` нет → INSERT новой записи
4. Обновление счетчика статистики в таблице `files` (опционально):
    - Увеличение счетчика обработок
    - Обновление времени последней обработки
5. Коммит транзакции

## 5. Создание записи аудита

**После успешного обновления:**
1. Вставка записи в таблицу `files_audit`:
    - `file_id` = идентификатор файла
    - `changed_by` = 'text-extraction-service'
    - `operation` = 'STATUS_UPDATE'
    - `old_data` = JSON с предыдущим статусом и метаданными
    - `new_data` = JSON с новым статусом и метаданными
2. Запись включает причину изменения (для failed) или метрики (для completed)

## 6. Отправка события в Kafka

**Подготовка события:**
- **Топик:** `file.events.status_updated`
- **Структура события:**
    - `event_type`: 'ProcessingStatusUpdated'
    - `file_id`: идентификатор файла
    - `old_status`: предыдущий статус
    - `new_status`: новый статус
    - `timestamp`: время изменения
    - `processing_time_ms`: время обработки (если предоставлено)
    - `error_details`: детали ошибки (только для 'failed')

**Логика отправки:**
1. Генерация уникального ID события
2. Установка ключа партиционирования = `file_id`
3. Отправка с гарантиями доставки (`acks=all`)
4. При ошибке отправки: 3 попытки ретрая

## 7. Логирование и метрики

**Последовательные операции:**
1. Запись в лог деталей обновления:
    - file_id
    - Старое и новое значение статуса
    - Время выполнения операции
    - Размер текста (если completed)
2. Обновление метрик Prometheus:
    - `files_processed_total` (с тегами status)
    - `processing_duration_seconds` (гистограмма)
    - `text_length_bytes` (для completed)
3. Алертинг при переходе в статус 'failed':
    - Уведомление для мониторинга
    - Сбор статистики частых ошибок

## Ошибки

| Код ошибки | Условие | Действие |
|------------|---------|----------|
| `INVALID_FILE_ID` | Некорректный формат UUID | Прекратить обработку |
| `FILE_NOT_FOUND` | Файл не существует в БД | Прекратить обработку |
| `INVALID_STATUS_TRANSITION` | Недопустимое изменение статуса (например, completed → processing) | Прекратить обработку, логировать |
| `MISSING_REQUIRED_DATA` | Для статуса 'completed' нет extracted_text | Прекратить обработку |
| `DATABASE_ERROR` | Ошибка подключения или выполнения запроса | Ретрай с экспоненциальной задержкой |
| `AUDIT_LOG_FAILED` | Ошибка записи в таблицу аудита | Продолжить, но логировать ошибку |
| `KAFKA_ERROR` | Ошибка отправки события | Ретрай отправки, но статус в БД обновлен |

## Специальные случаи

### Частичный успех:
- Текст извлечен, но с предупреждениями (например, не все страницы)
- Статус: 'completed_with_warnings'
- В `error_message` сохраняются предупреждения
- В `text_metadata` детализация проблем

### Длительная обработка:
- Для статуса 'processing' установлен таймаут (например, 30 минут)
- Если обработка превышает таймаут, внешний процесс может сбросить статус
- Мониторинг "зависших" обработок

### Повторная обработка failed:
- При получении нового события FileUploaded для файла в статусе 'failed'
- Сброс статуса на 'pending' для повторной попытки
- Инкремент счетчика попыток
